name: Terraform Apply

on:
  repository_dispatch:
    types: [terraform-apply-approved]

permissions:
  id-token: write
  contents: read
  actions: write

jobs:
  apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    env:
      ENVIRONMENT: ${{ github.event.client_payload.environment }}
      ACCOUNT_NUMBER: ${{ github.event.client_payload.account_number }}
      AWS_REGION: ${{ github.event.client_payload.aws_region }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-oidc-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        working-directory: ./terraform
        run: |
          echo "Initializing Terraform..."
          terraform init

      - name: Terraform Workspace
        working-directory: ./terraform
        run: |
          terraform workspace select -or-create ${{ env.ENVIRONMENT }}

      - name: Download Latest Plan Artifact
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: terraform-plan.yml
          workflow_conclusion: success
          name: tfplan-${{ env.ENVIRONMENT }}
          path: ./terraform

      - name: Verify Plan Exists
        working-directory: ./terraform
        run: |
          if [ ! -f "tfplan-${{ env.ENVIRONMENT }}" ]; then
              echo "Error: Plan file not found!"
              echo "Make sure a plan workflow completed successfully for ${{ env.ENVIRONMENT }}."
              exit 1
          fi
          echo "Plan file found"

      - name: Terraform Apply
        working-directory: ./terraform
        run: |
          echo "Applying Terraform plan for ${{ env.ENVIRONMENT }}..."
          terraform apply -auto-approve tfplan-${{ env.ENVIRONMENT }}

      - name: Deployment Summary
        run: |
          echo "Deployment to ${{ env.ENVIRONMENT }} completed successfully!"
          echo "Approved by: ${{ github.actor }}"
          echo "Timestamp: $(date)"
