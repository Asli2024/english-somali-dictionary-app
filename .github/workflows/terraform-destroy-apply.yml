name: Terraform Destroy Apply

on:
  repository_dispatch:
    types: [terraform-destroy-apply-approved]

permissions:
  id-token: write
  contents: read
  actions: write

jobs:
  destroy_apply:
    name: Terraform Destroy Apply
    runs-on: ubuntu-latest
    env:
      ENVIRONMENT: ${{ github.event.client_payload.environment }}
      ACCOUNT_NUMBER: ${{ github.event.client_payload.account_number }}
      AWS_REGION: ${{ github.event.client_payload.aws_region }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-oidc-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        working-directory: ./terraform
        run: |
          terraform init

      - name: Terraform Workspace
        working-directory: ./terraform
        run: |
          terraform workspace select -or-create ${{ env.ENVIRONMENT }}

      - name: Download Destroy Plan Artifact
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: terraform-destroy-plan.yml
          workflow_conclusion: success
          name: tfplan-destroy-${{ env.ENVIRONMENT }}
          path: ./terraform

      - name: Verify Destroy Plan Exists
        working-directory: ./terraform
        run: |
          if [ ! -f "tfplan-destroy-${{ env.ENVIRONMENT }}" ]; then
              echo "Error: Destroy plan file not found!"
              echo "Make sure a destroy plan workflow completed successfully for ${{ env.ENVIRONMENT }}."
              exit 1
          fi
          echo "Destroy plan file found"

      - name: Terraform Destroy Apply
        working-directory: ./terraform
        run: |
          echo "Applying Terraform destroy plan for ${{ env.ENVIRONMENT }}..."
          terraform apply -auto-approve tfplan-destroy-${{ env.ENVIRONMENT }}

      - name: Destroy Summary
        run: |
          echo "Destroy completed for ${{ env.ENVIRONMENT }}!"
          echo "Approved by: ${{ github.actor }}"
          echo "Timestamp: $(date)"
          echo "Region: ${{ env.AWS_REGION }}"
