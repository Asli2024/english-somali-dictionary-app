name: Docker Build and Push

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy (dev, staging, prod)"
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      account_number:
        description: "AWS Account Number"
        required: true
      aws_region:
        description: "AWS Region"
        required: true
        default: "eu-west-2"

permissions:
  id-token: write
  contents: read
  security-events: write

env:
  AWS_REGION: ${{ github.event.inputs.aws_region || 'eu-west-2' }}
  AWS_ACCOUNT_ID: ${{ github.event.inputs.account_number || secrets.AWS_ACCOUNT_ID }}
  ECR_REPOSITORY: english-somali-dictionary-app-ecr-repo

jobs:
  build-and-scan:
    name: Build and Scan Docker Image
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      image-tag: ${{ steps.image-tag.outputs.tag }}
      image-uri: ${{ steps.image-uri.outputs.uri }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-oidc-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Determine Image Tag
        id: image-tag
        run: |
          IMAGE_TAG="${{ github.sha }}"
          echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "Using image tag: ${IMAGE_TAG}"

      - name: Extract Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}
          tags: |
            type=raw,value=${{ steps.image-tag.outputs.tag }}

      - name: Run Trivy Vulnerability Scanner (Dockerfile)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "config"
          scan-ref: "english-dictionary/Dockerfile"
          exit-code: "0"
          severity: "HIGH,CRITICAL"

      - name: Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./english-dictionary
          file: ./english-dictionary/Dockerfile
          platforms: linux/arm64
          push: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1
          outputs: type=docker,dest=/tmp/image.tar

      - name: Run Trivy vulnerability scanner on built image
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "image"
          input: "/tmp/image.tar"
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"
        env:
          TRIVY_PLATFORM: "linux/arm64"

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

      - name: Upload Docker Image
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/image.tar
          retention-days: 1

      - name: Set Image URI
        id: image-uri
        run: |
          IMAGE_URI="${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:${{ steps.image-tag.outputs.tag }}"
          echo "uri=${IMAGE_URI}" >> $GITHUB_OUTPUT
          echo "Docker image built successfully!"
          echo "Repository: ${{ env.ECR_REPOSITORY }}"
          echo "Tag: ${{ steps.image-tag.outputs.tag }}"
          echo "Region: ${{ env.AWS_REGION }}"
          echo "Full Image URI: ${IMAGE_URI}"

  approval:
    name: Approve Push to ECR
    runs-on: ubuntu-latest
    needs: [build-and-scan]
    environment:
      name: push-approval-${{ github.event.inputs.environment }}
    steps:
      - name: Request Push Approval
        run: |
          echo "Build completed successfully!"
          echo "Requesting approval to push to ${{ github.event.inputs.environment }} ECR"
          echo "Image: ${{ needs.build-and-scan.outputs.image-uri }}"

  push-to-ecr:
    name: Push to ECR
    runs-on: ubuntu-latest
    needs: [build-and-scan, approval]
    if: always() && needs.build-and-scan.result == 'success' && needs.approval.result == 'success'
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-oidc-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load and Push Docker Image
        run: |
          # Load the image and capture the loaded image name
          LOADED_IMAGE=$(docker load -i /tmp/image.tar | grep "Loaded image:" | cut -d' ' -f3)
          echo "Loaded image: $LOADED_IMAGE"

          # Push the loaded image
          docker push $LOADED_IMAGE

      - name: Push Summary
        run: |
          echo "Docker image pushed successfully!"
          echo "Repository: ${{ env.ECR_REPOSITORY }}"
          echo "Tag: ${{ needs.build-and-scan.outputs.image-tag }}"
          echo "Region: ${{ env.AWS_REGION }}"
          echo "Image URI: ${{ needs.build-and-scan.outputs.image-uri }}"
